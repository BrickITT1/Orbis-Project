<!DOCTYPE html>
<html>
<head>
  <title>Voice Chat</title>
</head>
<body>
  <button id="start">Join Call</button>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let peerConnection;

    // Конфигурация WebRTC
    const config = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };

    document.getElementById('start').addEventListener('click', async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      
      peerConnection = new RTCPeerConnection(config);
      
      // Добавляем аудио-трек
      stream.getTracks().forEach(track => {
        peerConnection.addTrack(track, stream);
      });

      // Обработчики ICE кандидатов
      peerConnection.onicecandidate = ({ candidate }) => {
        if (candidate) {
          socket.emit('ice-candidate', candidate);
        }
      };

      // Обработчик входящих потоков
      peerConnection.ontrack = ({ streams }) => {
        const audio = document.createElement('audio');
        audio.srcObject = streams[0];
        audio.autoplay = true;
        document.body.appendChild(audio);
      };

      // Сигналинг
      socket.on('offer', async offer => {
        await peerConnection.setRemoteDescription(offer);
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit('answer', answer);
      });

      socket.on('answer', answer => {
        peerConnection.setRemoteDescription(answer);
      });

      socket.on('ice-candidate', candidate => {
        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      });

      // Создаем предложение
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit('offer', offer);
    });
  </script>
</body>
</html>